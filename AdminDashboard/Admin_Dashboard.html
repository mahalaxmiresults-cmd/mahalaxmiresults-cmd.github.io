<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Result Update</title>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyA39tWy3eQ7sImuHthW36icGSRdcCbH_CE",
  databaseURL: "https://mahalaxmi-result-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ================= ELEMENTS ================= */
const citySelect = document.getElementById("citySelect");
const dateInput = document.getElementById("dateInput");
const timeInput = document.getElementById("timeInput");
const resultInput = document.getElementById("resultInput");
const updateBtn = document.querySelector(".update-btn");
const gridBody = document.getElementById("gridBody");

const filterCity = document.getElementById("filterCity");
const filterDate = document.getElementById("filterDate");
const filterBtn = document.getElementById("filterBtn");

/* ================= DEFAULT DATE ================= */
dateInput.value = new Date().toISOString().split("T")[0];

/* ================= SAVE NEW RESULT ================= */
updateBtn.addEventListener("click", () => {
    const city = citySelect.value;
    const date = dateInput.value;
    const time = timeInput.value;
    const result = resultInput.value;

    if (!date || !time || result === "") {
        alert("Fill all fields!");
        return;
    }

    const dateTime = `${date}T${time}`;
    const now = new Date().toISOString().replace("T"," ").substring(0,16);

    set(ref(db, `results/${city}/${dateTime}`), {
        number: result,
        modifiedAt: now
    }).then(() => {
        alert("Saved Successfully!");
        resultInput.value = "";
    });
});

/* ================= LOAD GRID ================= */
function loadGrid(cityFilter = "", dateFilter = "") {
    onValue(ref(db, "results"), snapshot => {
        gridBody.innerHTML = "";
        const data = snapshot.val();
        if (!data) return;

        const rows = [];

        for (let city in data) {
            if (cityFilter && city !== cityFilter) continue;

            for (let dateTime in data[city]) {
                if (dateFilter && !dateTime.startsWith(dateFilter)) continue;

                const item = data[city][dateTime];

                rows.push({
                    city,
                    dateTime,
                    number: item.number,
                    modifiedAt: item.modifiedAt || "-"
                });
            }
        }

        rows.sort((a,b)=> new Date(b.dateTime) - new Date(a.dateTime));

        rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.city}</td>
                <td>${row.dateTime.replace("T"," ")}</td>
                <td><input type="number" value="${row.number}" disabled class="grid-input"></td>
                <td>${row.modifiedAt}</td>
                <td><button class="edit-btn">Edit</button></td>
            `;

            const input = tr.querySelector(".grid-input");
            const btn = tr.querySelector(".edit-btn");

            btn.onclick = () => {
                if (btn.innerText === "Edit") {
                    input.disabled = false;
                    input.focus();
                    btn.innerText = "Save";
                    btn.style.background = "#ff9800";
                } else {
                    if (input.value === "") {
                        alert("Result required!");
                        return;
                    }

                    const now = new Date().toISOString().replace("T"," ").substring(0,16);

                    set(ref(db, `results/${row.city}/${row.dateTime}`), {
                        number: input.value,
                        modifiedAt: now
                    }).then(() => {
                        input.disabled = true;
                        btn.innerText = "Edit";
                        btn.style.background = "#4caf50";
                    });
                }
            };

            gridBody.appendChild(tr);
        });
    });
}

/* ================= FILTER ================= */
filterBtn.onclick = () => {
    loadGrid(filterCity.value, filterDate.value);
};

/* INITIAL LOAD */
loadGrid();
</script>

<style>
body {
    font-family: Arial;
    background: #1e2633;
    color: #fff;
}
.container {
    width: 95%;
    max-width: 800px;
    margin: 30px auto;
}
.form-card {
    background: #2c3444;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}
label {
    display: block;
    margin-top: 10px;
}
select, input {
    width: 100%;
    padding: 10px;
    background: #1f2733;
    border: none;
    color: #fff;
}
.update-btn {
    margin-top: 15px;
    padding: 12px;
    width: 100%;
    background: #ff3f7f;
    border: none;
    color: #fff;
    cursor: pointer;
}
table {
    width: 100%;
    border-collapse: collapse;
    background: #2c3444;
}
th, td {
    border: 1px solid #444;
    padding: 8px;
    text-align: center;
}
th {
    background: #1f2733;
}
.grid-input {
    width: 70px;
    background: #1f2733;
    border: none;
    color: #fff;
    text-align: center;
}
.edit-btn {
    padding: 5px 12px;
    background: #4caf50;
    border: none;
    color: #fff;
    cursor: pointer;
}
</style>
</head>

<body>
<div class="container">
    <h2>Result Update</h2>

    <!-- ADD RESULT -->
    <div class="form-card">
        <label>City</label>
        <select id="citySelect">
            <option>FARIDABAD</option>
            <option>MAHA LAXMI</option>
            <option>GURGAON</option>
            <option>DELHI BAZAAR</option>
            <option>SHREE GANESH</option>
            <option>GALI</option>
            <option>DISAWAR</option>
            <option>GHAZIABAD</option>
        </select>

        <label>Date</label>
        <input type="date" id="dateInput">

        <label>Time</label>
        <input type="time" id="timeInput">

        <label>Result</label>
        <input type="number" id="resultInput">

        <button class="update-btn">UPDATE</button>
    </div>

    <!-- FILTER -->
    <div class="form-card">
        <label>Filter City</label>
        <select id="filterCity">
            <option value="">ALL</option>
            <option>FARIDABAD</option>
            <option>MAHA LAXMI</option>
            <option>GURGAON</option>
            <option>DELHI BAZAAR</option>
            <option>SHREE GANESH</option>
            <option>GALI</option>
            <option>DISAWAR</option>
            <option>GHAZIABAD</option>
        </select>

        <label>Filter Date</label>
        <input type="date" id="filterDate">

        <button class="update-btn" id="filterBtn">FILTER</button>
    </div>

    <!-- GRID -->
    <table>
        <thead>
            <tr>
                <th>City</th>
                <th>Date & Time</th>
                <th>Result</th>
                <th>Modified At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="gridBody"></tbody>
    </table>
</div>
</body>
</html>
